<!DOCTYPE html>
<html>
  <head>
    <title>Curveball</title>
    <script type="application/javascript" src="jquery-2.1.4.min.js"></script>
		<script type="application/javascript" src="three.min.js"></script>
		<script type="application/javascript" src="init.js"></script>
		<script type="application/javascript" src="ball.js"></script>
		<script type="application/javascript" src="paddle.js"></script>
  </head>
  <body>
    <div id="canvas" style="width: 1000px; height: 600px;"></div>
    <script>
      $(document).ready(function () {
        $('#canvas').on('mouseenter', function () {
          $('#canvas').css('cursor', 'none');
        });

        $('#canvas').on('mousedown', function () {
          if (ball.inPlay) return;

          if (paddleCollision()) {
            var oldX = playerMesh.position.x;
            var oldY = playerMesh.position.y;
            $('#canvas').one('mouseup', function () {
              if (paddleCollision()) {
                ball.updateSpin(oldX, oldY, playerMesh);
                ball.start();
              }
            });
          }
        });
      });
    </script>

    <script>
      var canvasWidth, canvasHeight;
      var scene, camera, renderer;
      var backWallMesh, leftWallMesh, rightWallMesh, floorMesh, ceilingMesh;
      var radius, ball, ballMesh;
      var paddleWidth, paddleHeight, player, playerMesh, comp, compMesh;

      init();
      var ball = new Ball(ballMesh);
      var player = new Paddle(playerMesh);
      var comp = new Paddle(compMesh);
      renderer.render(scene, camera);
      animate();

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);

        detectCollisions();

        playerMesh.position.x = player.posX;
        playerMesh.position.y = player.posY;

        // ball.speedX += ball.spinX;
        // ball.speedY += ball.spinY;
        ball.spin();

        ballMesh.position.x += ball.speedX;
        ballMesh.position.y += ball.speedY;
        ballMesh.position.z += ball.speedZ;
      }

      function detectCollisions() {
        if (ballMesh.position.x <= leftWallMesh.position.x + radius) {
          ballMesh.position.x = leftWallMesh.position.x + radius;
          ball.speedX *= -1;
        } else if (ballMesh.position.x >= rightWallMesh.position.x - radius) {
          ballMesh.position.x = rightWallMesh.position.x - radius;
          ball.speedX *= -1;
        }

        if (ballMesh.position.y <= floorMesh.position.y + radius) {
          ballMesh.position.y = floorMesh.position.y + radius;
          ball.speedY *= -1;
        } else if (ballMesh.position.y >= ceilingMesh.position.y - radius) {
          ballMesh.position.y = ceilingMesh.position.y - radius;
          ball.speedY *= -1;
        }

        // if (ballMesh.position.z <= backWallMesh.position.z + radius) {
        //   ballMesh.position.z = backWallMesh.position.z + radius;
        //   ball.speedZ *= -1;
        //   ball.resetSpin();
        // } else if (ballMesh.position.z > -radius) {
        //   if (paddleCollision()) {
        //     ballMesh.position.z = -radius;
        //     ball.speedZ *= -1;
        //     getPaddleSpeed();
        //   } else {
        //     ball.stop();
        //     setTimeout(function () {
        //       ball.reset();
        //     }, 1000);
        //   }
        // }
      }

      function paddleCollision () {
        if (ball.dead) return;

        var points = ball.getCollisionPoints();
        for (var i = 0; i < points.length; i++) {
          var raycaster = new THREE.Raycaster(points[i], new THREE.Vector3(0, 0, 1));
          var intersects = raycaster.intersectObjects(scene.children);
          if (intersects.length > 0) {
            return true;
          }
        }
        return false;
      }

      function getPaddleSpeed () {
        var oldX = playerMesh.position.x;
        var oldY = playerMesh.position.y;
        setTimeout(function () {
          ball.updateSpin(oldX, oldY, playerMesh);
        }, 0);
      }
    </script>
  </body>
</html>
